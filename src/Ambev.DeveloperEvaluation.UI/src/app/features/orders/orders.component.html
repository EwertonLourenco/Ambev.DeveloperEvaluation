<section class="container">
  <div class="card">
    <div class="toolbar">
      <input class="input" style="min-width:240px" placeholder="Buscar descrição..."
             [(ngModel)]="search" (keyup.enter)="load()">
      <select class="select" style="width:120px" [(ngModel)]="pageSize" (change)="load()">
        <option [ngValue]="5">5</option>
        <option [ngValue]="10">10</option>
        <option [ngValue]="20">20</option>
      </select>
      <button class="btn" (click)="load()">Atualizar</button>
      <span class="spacer"></span>
      <button class="btn btn-primary" (click)="toggleCreate()">
        {{ creating ? 'Fechar' : 'Novo Pedido' }}
      </button>
    </div>

    <div *ngIf="errorMsg" class="card" style="margin:8px 0; border-color: rgba(239,68,68,.4)">
      <strong>Erro:</strong> <span class="muted">{{ errorMsg }}</span>
    </div>

    <div *ngIf="creating" class="card" style="margin:8px 0">
      <div class="inline" style="margin-bottom:8px">
        <input class="input" style="width:120px" type="number" placeholder="Desconto %"
               [(ngModel)]="discountPercent">
      </div>

      <div *ngFor="let it of newItems; let i = index" class="inline">
        <input class="input" style="flex:1" placeholder="Descrição" [(ngModel)]="newItems[i].description">
        <input class="input" style="width:140px" type="number" placeholder="Preço" [(ngModel)]="newItems[i].unitPrice">
        <input class="input" style="width:120px" type="number" placeholder="Qtd" [(ngModel)]="newItems[i].quantity">
        <button class="btn" (click)="removeItem(i)" *ngIf="newItems.length>1">Remover</button>
      </div>

      <div class="inline" style="margin-top:10px">
        <button class="btn" (click)="addItem()">Adicionar item</button>
        <span class="spacer"></span>
        <span class="badge small">Subtotal: {{ newSubtotal | number:'1.2-2' }}</span>
        <span class="badge small">Desc.: {{ newDiscountAmount | number:'1.2-2' }}</span>
        <span class="badge small">Total: {{ newTotal | number:'1.2-2' }}</span>
        <button class="btn btn-primary" (click)="create()">Salvar</button>
      </div>
    </div>

    <div *ngIf="loading" class="muted">Carregando...</div>

    <table class="table" *ngIf="!loading && data?.items?.length">
      <thead>
        <tr>
          <th>ID</th>
          <th>Criado em</th>
          <th style="text-align:right">Subtotal</th>
          <th style="text-align:right">Desconto</th>
          <th style="text-align:right">Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let o of data.items">
          <td>{{ o.id }}</td>
          <td>{{ o.createdAt | date:'short' }}</td>
          <td style="text-align:right">{{ o.subtotal | number:'1.2-2' }}</td>
          <td style="text-align:right">
            {{ o.discountPercent ?? 0 }}% ({{ o.discountAmount | number:'1.2-2' }})
          </td>
          <td style="text-align:right">{{ o.total | number:'1.2-2' }}</td>
          <td class="row-actions">
            <button class="btn btn-outline" (click)="openDetail(o.id!)">Editar</button>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="!loading && !data?.items?.length" class="muted">Nenhum pedido encontrado.</div>

    <!-- paginação -->
    <div class="inline" style="margin-top:12px" *ngIf="!loading && (data?.totalPages ?? 0) > 1">
      <button class="btn" (click)="prev()" [disabled]="data.currentPage <= 1">Anterior</button>
      <span class="badge small">Página {{ data.currentPage }} de {{ data.totalPages }}</span>
      <button class="btn" (click)="next()" [disabled]="!data.hasNext">Próxima</button>

      <span class="spacer"></span>
      <span class="muted">Total: {{ data.totalCount }}</span>
    </div>
  </div>
</section>
